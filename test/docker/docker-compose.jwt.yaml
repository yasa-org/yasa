#
# Licensed to the Apache Software Foundation (ASF) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# The ASF licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

version: '2'

services:
  solr:
    image: solr:8.8.1
    ports:
      - 8983:8983
    user: 'root:root'
    volumes:
      - ./security.jwt.json:/opt/solr-8.8.1/server/solr/security.json
    environment:
      SOLR_OPTS: "-Dsolr.auth.jwt.allowOutboundHttp=true -Denable.packages=true"
    entrypoint:
      - sh
      - -c
      - |
        solr start -force -e cloud -noprompt -Denable.packages=true
        bin/solr package add-repo yasa "http://server:8000/"
        bin/solr package install yasa
        bin/solr package deploy yasa -y -cluster
        bin/solr zk cp file:server/solr/security.json zk:/security.json -z localhost:9983
        tail -f /dev/null
    depends_on:
      server:
        condition: service_healthy

  keycloak:
    image: quay.io/keycloak/keycloak:12.0.2
    command: [ "-b", "0.0.0.0", "-Dkeycloak.migration.action=import", "-Dkeycloak.migration.provider=dir", "-Dkeycloak.migration.dir=/opt/jboss/keycloak/realm-config", "-Dkeycloak.migration.strategy=OVERWRITE_EXISTING", "-Djboss.socket.binding.port-offset=1000", "-Dkeycloak.profile.feature.upload_scripts=enabled" ]
    ports:
      - 9080:9080
      - 9443:9443
    environment:
      KEYCLOAK_USER: admin
      KEYCLOAK_PASSWORD: password
      DB_VENDOR: h2
    volumes:
      - ./keycloak/realm-config:/opt/jboss/keycloak/realm-config
    healthcheck:
      test: [ "CMD", "bash", "-c", "curl -s 'http://localhost:9080/auth/realms/solr'" ]
      interval: 5s
      timeout: 60s
      retries: 120

  server:
    build:
      context: ../..
      dockerfile: test/docker/Dockerfile
    expose:
      - 8000
    healthcheck:
      test: [ "CMD", "bash", "-c", "cat < /dev/null > /dev/tcp/127.0.0.1/8000" ]
      interval: 5s
      timeout: 60s
      retries: 120
